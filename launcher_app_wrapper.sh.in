#!/bin/sh
set -e
set -x

# ##################################################
# user configurable settings
# ##################################################

# absolute path to project root
FISHCOUNTER_ROOT="/home/orangepi/fishcounter"

# absolute path to config file
FISHCOUNTER_CONFIG="/home/orangepi/fishcounter/config.yaml"

# absolute path to python virtual environment
FISHCOUNTER_PYTHON_VIRTUAL_ENVIRONMENT="/home/orangepi/venv3"

# absolute path to log
FISHCOUNTER_LOG="/tmp/fishcounter.log"
FISHCOUNTER_RUNNER_LOG="/tmp/fishcounter_runner.log"

# run as user
PROCESS_USER="orangepi"
PROCESS_GROUP="orangepi"

# pause starting program because desktop maybe not ready before crontab is
# called, this is for halting the program before running
SLEEP_AMOUNT="15"

# where is sleep executable
E_SLEEP="/usr/bin/sleep"

# where is sudo executable
E_SUDO="/usr/bin/sudo"

# where is mktemp executable
E_MKTEMP="/usr/bin/mktemp"

# where is rm executable
E_RM="/usr/bin/rm"

# where is chmod executable
E_CHMOD="/usr/bin/chmod"

# where is chown executable
E_CHOWN="/usr/bin/chown"

# where is touch executable
E_TOUCH="/usr/bin/touch"

# ##################################################
# timed halt
# ##################################################

# check if we get argument "--forward"
if [ \( "$#" -gt "0" \) -a \( "x$1" = "x--forward" \) ] ; then
	# tell secondary script that we forwarding X11
	ARE_WE_FORWARDING_X11="yes"

	# do not need to halt before running secondary script
else
	# we dont forwarding X11, this means that
	# we running this script from crontab or some startup/init script
	ARE_WE_FORWARDING_X11="no"

	# halt a before running secondary script
	# it is ok to halt here, because startup script/crontab
	# running this script in background anyway
	"$E_SLEEP" "$SLEEP_AMOUNT"
fi

# create secondary script as a wrapper for activating python environment then running the program
SECONDARY_SCRIPT="$("$E_MKTEMP")"
if [ -z "$SECONDARY_SCRIPT" ] ; then
	# exit if we cannot make temporary script
	exit 1
fi

# sh script
# 1. set display variable (display program in monitor 0, seat 0)
# 2. activate python environment
# 3. change directory to src, where launcher_app.py is
# 4. run actual launcher
# 5. deactivate python virtual environment
cat <<EOF > "$SECONDARY_SCRIPT"
#!/bin/sh
set -e
set -x
ARE_WE_FORWARDING_X11="$ARE_WE_FORWARDING_X11"
if   [ "\$ARE_WE_FORWARDING_X11" = "yes" ] ; then
	: # do nothing
elif [ "\$ARE_WE_FORWARDING_X11" =  "no" ] ; then
	export DISPLAY=":0"
else
	exit 1
fi
. "$FISHCOUNTER_PYTHON_VIRTUAL_ENVIRONMENT/bin/activate"
cd "$FISHCOUNTER_ROOT/src"
"\$PWD/launcher_app.py" --config "$FISHCOUNTER_CONFIG" >> "$FISHCOUNTER_LOG" 2>&1
deactivate
EOF

# change secondary script permission
"$E_CHMOD" --verbose "ugoa+rx,go-w" "$SECONDARY_SCRIPT"

# create log file
"$E_TOUCH" "$FISHCOUNTER_LOG"

# change log file ownership and permission
"$E_CHOWN" --verbose "$PROCESS_USER:$PROCESS_GROUP" "$FISHCOUNTER_LOG"
"$E_CHMOD" --verbose "u+w,go-w,ugoa-x"              "$FISHCOUNTER_LOG"

# run secondary script as user (directory change to where launcher_app.py is done in secondary script)
"$E_SUDO" -u "$PROCESS_USER" -g "$PROCESS_GROUP" "$SECONDARY_SCRIPT" >> "$FISHCOUNTER_RUNNER_LOG" 2>&1

# delete temporary script after program exit
"$E_RM" --verbose "$SECONDARY_SCRIPT"
